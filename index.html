<script>
    // 1. Update Jam dan Tanggal
    function updateTime() {
        const n = new Date();
        document.getElementById('big-clock').innerText = n.toLocaleTimeString('id-ID', {hour:'2-digit', minute:'2-digit'});
        document.getElementById('big-date').innerText = n.toLocaleDateString('id-ID', {weekday:'long', day:'numeric', month:'long', year:'numeric'});
    }
    setInterval(updateTime, 1000); 
    updateTime();

    // 2. Fokus Otomatis
    document.addEventListener('click', () => document.getElementById('barcode-input').focus());
    
    // 3. Logika Scan
    document.getElementById('barcode-input').addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
            const val = e.target.value.trim();
            if (val !== "") showDisplay(val);
            e.target.value = '';
        }
    });

    // 4. Fungsi Menampilkan Data & Simpan Absensi
    async function showDisplay(id) {
        try {
            const students = await getStudents();
            const s = students.find(item => String(item.id) === String(id).trim());

            // Ganti Tampilan ke Student View
            document.getElementById('idle-view').classList.add('hidden');
            document.getElementById('student-view').classList.remove('hidden');

            const photoEl = document.getElementById('p-img');
            const statusEl = document.getElementById('p-status');

            if (s) {
                // Isi Data Siswa
                document.getElementById('p-name').innerText = s.name;
                document.getElementById('p-id').innerText = s.id;
                document.getElementById('p-class').innerText = s.kelas;
                
                // Logika Foto
                photoEl.src = `img/siswa/${s.id}.jpg`;
                photoEl.onerror = function() {
                    this.onerror = null; 
                    this.src = `img/siswa/${s.id}.png`;
                    this.setAttribute('onerror', "this.src='https://via.placeholder.com/150x180?text=Tanpa+Foto'");
                };

                // --- PERBAIKAN LOGIKA STATUS (TERMASUK PULANG) ---
                const config = getConfig();
                const sekarang = new Date();
                const jamAngka = sekarang.getHours();
                const jamMenit = sekarang.toLocaleTimeString('id-ID', {hour12:false, hour:'2-digit', minute:'2-digit'});
                
                let status = "";
                let statusClass = "";

                if (jamAngka >= 12) {
                    status = "PULANG";
                    statusClass = "status-blue"; // Pastikan status-blue ada di style.css
                } else {
                    if (jamMenit <= config.jamMasuk) {
                        status = "TEPAT WAKTU";
                        statusClass = "status-ok";
                    } else {
                        status = "TERLAMBAT";
                        statusClass = "status-late";
                    }
                }
                
                statusEl.innerText = status;
                statusEl.className = "status-pill " + statusClass;

                // SIMPAN KE CLOUD & KIRIM WA (Panggil fungsi dari script-common.js)
                saveAttendanceAuto(s, status); 

            } else {
                // Jika Siswa Tidak Ditemukan
                document.getElementById('p-name').innerText = "DATA TIDAK ADA";
                document.getElementById('p-id').innerText = id;
                document.getElementById('p-class').innerText = "-";
                photoEl.src = 'https://via.placeholder.com/150x180?text=Error';
                statusEl.innerText = "GAGAL";
                statusEl.className = "status-pill status-late";
            }
        } catch (err) {
            console.error("Scan Error:", err);
        }

        // Kembali ke layar awal setelah 5 detik
        const timeoutId = setTimeout(() => {
            document.getElementById('idle-view').classList.remove('hidden');
            document.getElementById('student-view').classList.add('hidden');
            document.getElementById('barcode-input').focus();
        }, 5000);
    }
</script>
