<!DOCTYPE html>
<html lang="id">
<head>
Â  Â  <meta charset="UTF-8">
Â  Â  <title>Admin - SMP Sisingamangaraja</title>
Â  Â  <link rel="stylesheet" href="style.css">
Â  Â  <link rel="icon" type="image/png" href="img/logo87.PNG">
Â  Â  <script src="https://cdn.sheetjs.com/xlsx-0.20.0/package/dist/xlsx.full.min.js"></script>
Â  Â  <script>if(!sessionStorage.getItem('admin')) window.location.href='login.html';</script>
</head>
<body>
Â  Â  <div class="container-admin">
Â  Â  Â  Â  <aside class="sidebar">
Â  Â  Â  Â  Â  Â  <h2 style="border:none; font-size:16px; text-align:center;">SMP SISINGAMANGARAJA</h2>
Â  Â  Â  Â  Â  Â  <button onclick="show('laporan')">ğŸ“Š Laporan Absensi</button>
Â  Â  Â  Â  Â  Â  <button onclick="show('siswa')">ğŸ‘¥ Master Siswa</button>
Â  Â  Â  Â  Â  Â  <button onclick="show('set')">âš™ï¸ Pengaturan Jam</button>
Â  Â  Â  Â  Â  Â  <button onclick="show('rekap')">ğŸ“… Rekap Per Kelas</button>
Â  Â  Â  Â  Â  Â  <hr style="border: 0.5px solid #444; margin: 20px 0;">
Â  Â  Â  Â  Â  Â  <button onclick="exportToExcel()" style="background:#27ae60; color:white;">ğŸ“¥ Export Excel</button>
Â  Â  Â  Â  Â  Â  <button onclick="clearAllLogs()" style="background:#e74c3c; color:white;">ğŸ—‘ï¸ Hapus Semua Log</button>
Â  Â  Â  Â  Â  Â  <a href="index.html" style="background:#95a5a6; text-align:center; display:block; padding:10px; border-radius:5px; text-decoration:none; color:white; margin:10px 0;">ğŸ–¥ï¸ Dashboard</a>
Â  Â  Â  Â  Â  Â  <button onclick="sessionStorage.clear(); window.location.href='login.html'" style="background:#34495e; color:white; margin-top:20px;">Logout</button>
Â  Â  Â  Â  </aside>

Â  Â  Â  Â  <main class="content">
Â  Â  Â  Â  Â  Â  <section id="sec-laporan">
Â  Â  Â  Â  Â  Â  Â  Â  <h2>Laporan Kehadiran</h2>
Â  Â  Â  Â  Â  Â  Â  Â  <input type="text" id="search" placeholder="Cari Nama/Kelas..." onkeyup="render()" style="width:100%; padding:10px; border-radius:8px; border:1px solid #ddd; margin-bottom:15px;">
Â  Â  Â  Â  Â  Â  Â  Â  <table>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <thead>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <tr><th>Waktu</th><th>Nama</th><th>Kelas</th><th>Status</th><th>Aksi</th></tr>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </thead>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <tbody id="tbody-log"></tbody>
Â  Â  Â  Â  Â  Â  Â  Â  </table>
Â  Â  Â  Â  Â  Â  </section>

Â  Â  Â  Â  Â  Â  <section id="sec-siswa" class="hidden">
Â  Â  Â  Â  Â  Â  Â  Â  <div style="display: flex; justify-content: space-between; align-items: center;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <h2>Manajemen Data Siswa</h2>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div style="display: flex; gap: 10px;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button onclick="downloadTemplateExcel()" style="background:#f39c12; color:white; padding:10px; border:none; border-radius:5px; cursor:pointer;">ğŸ“„ Template</button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="file" id="file-ex" accept=".xlsx" style="display:none" onchange="importX(this)">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button onclick="document.getElementById('file-ex').click()" style="background:#3498db; color:white; border:none; padding:10px; border-radius:5px; cursor:pointer;">ğŸ“¤ Import Excel</button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  <p style="font-size: 12px; color: #666;">*Tips: Foto disimpan di <b>/img/siswa/[ID].jpg</b></p>
Â  Â  Â  Â  Â  Â  Â  Â  <table>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <thead>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <tr>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <th style="width:60px;">Foto</th>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <th>ID/NIS</th>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <th>Nama Siswa</th>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <th>Kelas</th>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <th>WA Orang Tua</th>Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <th style="text-align:center;">Aksi</th>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </tr>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </thead>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <tbody id="tbody-siswa"></tbody>
Â  Â  Â  Â  Â  Â  Â  Â  </table>
Â  Â  Â  Â  Â  Â  </section>

Â  Â  Â  Â  Â  Â  <section id="sec-set" class="hidden">
Â  Â  Â  Â  Â  Â  Â  Â  <h2>Pengaturan Jam</h2>
Â  Â  Â  Â  Â  Â  Â  Â  <label>Batas Jam Masuk (Tepat Waktu):</label><br>
Â  Â  Â  Â  Â  Â  Â  Â  <input type="time" id="jam-m" style="padding:10px; font-size:1.2rem; margin:10px 0;"><br>
Â  Â  Â  Â  Â  Â  Â  Â  <button onclick="saveS()" style="background:#27ae60; color:white; border:none; padding:10px 20px; border-radius:5px; cursor:pointer;">Simpan Pengaturan</button>
Â  Â  Â  Â  Â  Â  </section>

Â  Â  Â  Â  Â  Â  <section id="sec-rekap" class="hidden">
Â  Â  Â  Â  Â  Â  Â  Â  <h2>Rekap Absensi Per Kelas</h2>
Â  Â  Â  Â  Â  Â  Â  Â  <div style="display: flex; gap: 10px; margin-bottom: 15px;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <select id="filter-kelas" style="padding: 10px; border-radius: 5px; flex: 1;"></select>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="date" id="filter-tanggal" style="padding: 10px; border-radius: 5px; border: 1px solid #ccc;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button onclick="renderRekap()" style="background:#3498db; color:white; border:none; padding:10px 20px; border-radius:5px; cursor:pointer;">Tampilkan</button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button onclick="printRekap()" style="background:#27ae60; color:white; border:none; padding:10px 20px; border-radius:5px; cursor:pointer;">ğŸ–¨ï¸ Cetak PDF</button>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  <div id="rekap-result" style="background: white; padding: 20px; border-radius: 10px; border: 1px solid #ddd;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p>Pilih kelas dan tanggal terlebih dahulu.</p>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  </section>
Â  Â  Â  Â  </main>
Â  Â  </div>

Â  Â  <script src="script-common.js"></script>
Â  Â  <script>
Â  Â  Â  Â  document.getElementById('filter-tanggal').value = new Date().toISOString().split('T')[0];

Â  Â  Â  Â  function show(s) {
Â  Â  Â  Â  Â  Â  document.querySelectorAll('section').forEach(el => el.classList.add('hidden'));
Â  Â  Â  Â  Â  Â  document.getElementById('sec-' + s).classList.remove('hidden');Â 
Â  Â  Â  Â  Â  Â  if (s === 'rekap') updateKelasDropdown();
Â  Â  Â  Â  Â  Â  render();
Â  Â  Â  Â  }

Â  Â  Â  Â  // 1. RENDER UTAMA (Sync Cloud)
Â  Â  Â  Â  async function render() {
Â  Â  Â  Â  Â  Â  const q = document.getElementById('search').value.toLowerCase();
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  // Render Log Absensi
Â  Â  Â  Â  Â  Â  const logBody = document.getElementById('tbody-log');
Â  Â  Â  Â  Â  Â  if (logBody) {
Â  Â  Â  Â  Â  Â  Â  Â  logBody.innerHTML = `<tr><td colspan="5" style="text-align:center;">Memuat data log...</td></tr>`;
Â  Â  Â  Â  Â  Â  Â  Â  const allLogs = await getLogs();
Â  Â  Â  Â  Â  Â  Â  Â  const logs = allLogs.reverse().filter(l =>Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  l.name.toLowerCase().includes(q) ||Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  (l.kelas && l.kelas.toLowerCase().includes(q))
Â  Â  Â  Â  Â  Â  Â  Â  );

Â  Â  Â  Â  Â  Â  Â  Â  logBody.innerHTML = logs.length === 0 ? `<tr><td colspan="5" style="text-align:center;">Tidak ada data ditemukan</td></tr>` :Â 
Â  Â  Â  Â  Â  Â  Â  Â  logs.map(l => `
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <tr>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <td>${new Date(l.timestamp).toLocaleString('id-ID')}</td>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <td><b>${l.name}</b></td>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <td>${l.kelas}</td>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <td><span class="badge ${l.mode.toLowerCase().replace(' ', '-')}">${l.mode}</span></td>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <td><button onclick="delL('${l.timestamp}')" class="btn-del">Hapus</button></td>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </tr>`).join('');
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  // Render Master Siswa
Â  Â  Â  Â  Â  Â  const studentBody = document.getElementById('tbody-siswa');
Â  Â  Â  Â  Â  Â  if(studentBody) {
Â  Â  Â  Â  Â  Â  Â  Â  studentBody.innerHTML = `<tr><td colspan="6" style="text-align:center;">Memuat data siswa...</td></tr>`;
Â  Â  Â  Â  Â  Â  Â  Â  const students = await getStudents();
Â  Â  Â  Â  Â  Â  Â  Â  // Ganti bagian map di dalam fungsi render() dengan ini:
studentBody.innerHTML = students.map(s => `
    <tr>
        <td><img src="img/siswa/${s.id}.jpg" onerror="this.src='https://via.placeholder.com/45x55?text=ğŸ‘¤'" class="img-table"></td>
        <td><code>${s.id}</code></td>
        <td><b>${s.name}</b></td>
        <td>${s.kelas}</td>
        <td>${s.wa || '-'}</td>
        <td style="text-align:center;">
            <button onclick="editSiswa('${s.id}')" class="btn-edit">âœï¸ Edit</button>
            <button onclick="delS('${s.id}')" class="btn-del">ğŸ—‘ï¸ Hapus</button>
        </td>
    </tr>`).join('');
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }

Â  Â  Â  Â  async function updateKelasDropdown() {
Â  Â  Â  Â  Â  Â  const students = await getStudents();
Â  Â  Â  Â  Â  Â  const listKelas = [...new Set(students.map(s => s.kelas))].sort();
Â  Â  Â  Â  Â  Â  document.getElementById('filter-kelas').innerHTML = '<option value="">-- Pilih Kelas --</option>' +Â 
Â  Â  Â  Â  Â  Â  Â  Â  listKelas.map(k => `<option value="${k}">${k}</option>`).join('');
Â  Â  Â  Â  }

Â  Â  Â  Â  // 2. RENDER REKAP (Sync Cloud)
Â  Â  Â  Â  async function renderRekap() {
Â  Â  Â  Â  Â  Â  const kelas = document.getElementById('filter-kelas').value;
Â  Â  Â  Â  Â  Â  const tglInput = document.getElementById('filter-tanggal').value;
Â  Â  Â  Â  Â  Â  if (!kelas || !tglInput) return alert("Pilih kelas & tanggal!");
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  const rekapResult = document.getElementById('rekap-result');
Â  Â  Â  Â  Â  Â  rekapResult.innerHTML = "<p style='text-align:center;'>Mengambil data server...</p>";

Â  Â  Â  Â  Â  Â  const selectedDate = new Date(tglInput).toLocaleDateString('id-ID');
Â  Â  Â  Â  Â  Â  const studentsData = await getStudents();
Â  Â  Â  Â  Â  Â  const students = studentsData.filter(s => s.kelas === kelas);
Â  Â  Â  Â  Â  Â  const logs = await getLogs();

Â  Â  Â  Â  Â  Â  let html = `<h3>LAPORAN ABSENSI KELAS: ${kelas}</h3><p>Tanggal: <b>${selectedDate}</b></p>`;
Â  Â  Â  Â  Â  Â  html += `<table border="1" style="width:100%; border-collapse:collapse; margin-top:10px;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <thead><tr style="background:#f2f2f2;"><th>Nama Siswa</th><th>Status</th><th>Jam</th></tr></thead><tbody>`;

Â  Â  Â  Â  Â  Â  students.forEach(s => {
Â  Â  Â  Â  Â  Â  Â  Â  const log = logs.find(l => l.id === s.id && new Date(l.timestamp).toLocaleDateString('id-ID') === selectedDate);
Â  Â  Â  Â  Â  Â  Â  Â  const statusText = log ? log.mode : "Alpa / Belum Scan";
Â  Â  Â  Â  Â  Â  Â  Â  const jamText = log ? new Date(log.timestamp).toLocaleTimeString('id-ID', {hour:'2-digit', minute:'2-digit'}) : "-";
Â  Â  Â  Â  Â  Â  Â  Â  const colorStyle = !log ? 'color: red; font-weight: bold;' : '';

Â  Â  Â  Â  Â  Â  Â  Â  html += `<tr>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <td>${s.name}</td>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <td style="text-align:center; ${colorStyle}">${statusText}</td>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <td style="text-align:center;">${jamText}</td>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </tr>`;
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  html += `</tbody></table>`;
Â  Â  Â  Â  Â  Â  rekapResult.innerHTML = html;
Â  Â  Â  Â  }

Â  Â  Â  Â  // 3. MANAJEMEN DATA (Sync Cloud)
Â  Â  Â  Â  async function editSiswa(id) {
Â  Â  Â  Â  Â  Â  let students = await getStudents();
Â  Â  Â  Â  Â  Â  let index = students.findIndex(s => s.id === id);
Â  Â  Â  Â  Â  Â  if (index !== -1) {
Â  Â  Â  Â  Â  Â  Â  Â  const s = students[index];
Â  Â  Â  Â  Â  Â  Â  Â  const nNama = prompt("Edit Nama:", s.name); if (!nNama) return;
Â  Â  Â  Â  Â  Â  Â  Â  const nKelas = prompt("Edit Kelas:", s.kelas); if (!nKelas) return;
Â  Â  Â  Â  Â  Â  Â  Â  const nWA = prompt("Edit WA (62...):", s.wa); if (!nWA) return;

Â  Â  Â  Â  Â  Â  Â  Â  students[index].name = nNama;
Â  Â  Â  Â  Â  Â  Â  Â  students[index].kelas = nKelas;
Â  Â  Â  Â  Â  Â  Â  Â  students[index].wa = nWA.replace(/[^\d]/g, "");

Â  Â  Â  Â  Â  Â  Â  Â  await fetch(`${dbRootURL}master_siswa.json`, { method: 'PUT', body: JSON.stringify(students) });
Â  Â  Â  Â  Â  Â  Â  Â  alert("Data diperbarui di Cloud!");
Â  Â  Â  Â  Â  Â  Â  Â  render();
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }

Â  Â  Â  Â  async function delS(id) {
Â  Â  Â  Â  Â  Â  if(confirm('Hapus siswa ini dari Cloud?')) {
Â  Â  Â  Â  Â  Â  Â  Â  let students = await getStudents();
Â  Â  Â  Â  Â  Â  Â  Â  let filtered = students.filter(s => s.id !== id);
Â  Â  Â  Â  Â  Â  Â  Â  await fetch(`${dbRootURL}master_siswa.json`, { method: 'PUT', body: JSON.stringify(filtered) });
Â  Â  Â  Â  Â  Â  Â  Â  render();
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }

Â  Â  Â  Â  async function clearAllLogs() {Â 
Â  Â  Â  Â  Â  Â  if(confirm('Hapus SEMUA data absensi di Cloud secara permanen?')) {Â 
Â  Â  Â  Â  Â  Â  Â  Â  await fetch(`${dbRootURL}absensi.json`, { method: 'DELETE' });
Â  Â  Â  Â  Â  Â  Â  Â  render();
Â  Â  Â  Â  Â  Â  }Â 
Â  Â  Â  Â  }

Â  Â  Â  Â  async function delL(timestamp) {
Â  Â  Â  Â  Â  Â  alert("Untuk menghapus log spesifik, silakan kelola melalui Firebase Console demi integritas data.");
Â  Â  Â  Â  }

Â  Â  Â  Â  function saveS() {
Â  Â  Â  Â  Â  Â  localStorage.setItem('absensi_config', JSON.stringify({jamMasuk: document.getElementById('jam-m').value}));
Â  Â  Â  Â  Â  Â  alert('Konfigurasi jam tersimpan di browser ini!');
Â  Â  Â  Â  }

Â  Â  Â  Â  function printRekap() {
Â  Â  Â  Â  Â  Â  const content = document.getElementById('rekap-result').innerHTML;
Â  Â  Â  Â  Â  Â  if (content.includes("Pilih kelas")) return alert("Tampilkan data terlebih dahulu!");
Â  Â  Â  Â  Â  Â  const win = window.open('', '', 'height=700,width=900');
Â  Â  Â  Â  Â  Â  win.document.write('<html><head><title>Cetak Rekap Absensi</title><style>body{font-family:Arial; padding:30px} table{width:100%; border-collapse:collapse} th,td{border:1px solid #000; padding:8px; text-align:left} h3, p{text-align:center;}</style></head><body><div style="text-align:center;"><h2>SMP SWASTA SISINGAMANGARAJA</h2><p>Rekapitulasi Kehadiran Siswa</p><hr></div>' + content + '</body></html>');
Â  Â  Â  Â  Â  Â  win.document.close();
Â  Â  Â  Â  Â  Â  setTimeout(() => { win.print(); win.close(); }, 500);
Â  Â  Â  Â  }

Â  Â  Â  Â  // Inisialisasi
Â  Â  Â  Â  document.getElementById('jam-m').value = getConfig().jamMasuk;
Â  Â  Â  Â  render();
Â  Â  </script>
</body>
</html>

