<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <title>Admin - SMP Sisingamangaraja</title>
    <link rel="stylesheet" href="style.css">
    <link rel="icon" type="image/png" href="img/logo87.PNG">
    <script src="https://cdn.sheetjs.com/xlsx-0.20.0/package/dist/xlsx.full.min.js"></script>
    <script>if(!sessionStorage.getItem('admin')) window.location.href='login.html';</script>
    <style>
        /* Tambahan warna khusus untuk status Pulang agar seragam */
        .status-pill.status-blue { background-color: #3498db !important; color: white !important; }
        .status-pill.status-ok { background-color: #27ae60 !important; color: white !important; }
        .status-pill.status-late { background-color: #e74c3c !important; color: white !important; }
    </style>
</head>
<body>
    <div class="container-admin">
        <aside class="sidebar">
            <h2 style="border:none; font-size:16px; text-align:center; margin-bottom: 20px;">SMP SISINGAMANGARAJA</h2>
            <button onclick="show('laporan')">üìä Laporan Absensi</button>
            <button onclick="show('siswa')">üë• Master Siswa</button>
            <button onclick="show('set')">‚öôÔ∏è Pengaturan Jam</button>
            <button onclick="show('rekap')">üìÖ Rekap Per Kelas</button>
            
            <hr style="border: 0.5px solid #444; margin: 20px 0;">
            
            <button onclick="exportToExcel()" style="background:#27ae60; color:white;">üì• Export Excel</button>
            <button onclick="clearAllLogs()" style="background:#e74c3c; color:white;">üóëÔ∏è Hapus Semua Log</button>
            <a href="index.html" style="background:#34495e; text-align:center; display:block; padding:12px; border-radius:8px; text-decoration:none; color:white; margin:10px 0;">üñ•Ô∏è Dashboard</a>
            <button onclick="sessionStorage.clear(); window.location.href='login.html'" style="background:#2c3e50; color:white; margin-top:20px;">Logout</button>
        </aside>

        <main class="content">
            <section id="sec-laporan">
                <h2>Laporan Kehadiran</h2>
                <input type="text" id="search" placeholder="Cari Nama/Kelas..." onkeyup="render()" style="width:100%; padding:12px; border-radius:8px; border:1px solid #ddd; margin-bottom:15px;">
                <table>
                    <thead>
                        <tr>
                            <th>Waktu</th>
                            <th>Nama</th>
                            <th>Kelas</th>
                            <th>Status</th>
                            <th>Aksi</th>
                        </tr>
                    </thead>
                    <tbody id="tbody-log"></tbody>
                </table>
            </section>

            <section id="sec-siswa" class="hidden">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                    <h2>Manajemen Data Siswa</h2>
                    <div style="display: flex; gap: 10px;">
                        <button onclick="downloadTemplateExcel()" style="background:#f39c12; color:white; padding:10px 15px; border:none; border-radius:5px; cursor:pointer; font-weight:bold;">üìÑ Template</button>
                        <input type="file" id="file-ex" accept=".xlsx" style="display:none" onchange="importX(this)">
                        <button onclick="document.getElementById('file-ex').click()" style="background:#3498db; color:white; border:none; padding:10px 15px; border-radius:5px; cursor:pointer; font-weight:bold;">üì§ Import Excel</button>
                    </div>
                </div>
                <p style="font-size: 13px; color: #666; margin-bottom: 20px;">*Foto otomatis dari folder <b>/img/siswa/[ID].jpg atau .png</b></p>
                
                <table>
                    <thead>
                        <tr>
                            <th style="width:80px; text-align:center;">Foto</th>
                            <th style="width:120px;">ID/NIS</th>
                            <th>Nama Siswa</th>
                            <th style="width:80px;">Kelas</th>
                            <th>WA Orang Tua</th> 
                            <th style="text-align:center; width:150px;">Aksi</th>
                        </tr>
                    </thead>
                    <tbody id="tbody-siswa"></tbody>
                </table>
            </section>

            <section id="sec-set" class="hidden">
                <h2>Pengaturan Jam</h2>
                <div style="background:white; padding:20px; border-radius:10px; border:1px solid #ddd;">
                    <label>Batas Jam Masuk (Pagi):</label><br>
                    <input type="time" id="jam-m" style="padding:10px; font-size:1.2rem; margin:10px 0; border:1px solid #ddd; border-radius:5px;"><br>
                    <button onclick="saveS()" style="background:#27ae60; color:white; border:none; padding:10px 20px; border-radius:5px; cursor:pointer; font-weight:bold;">Simpan Pengaturan</button>
                    <p style="font-size: 12px; color: #666; margin-top: 10px;">*Sistem otomatis: Sebelum jam 12:00 (Masuk/Terlambat), Setelah jam 12:00 (Pulang).</p>
                </div>
            </section>

            <section id="sec-rekap" class="hidden">
                <h2>Rekap Absensi Per Kelas</h2>
                <div style="display: flex; gap: 10px; margin-bottom: 15px;">
                    <select id="filter-kelas" style="padding: 10px; border-radius: 5px; flex: 1; border:1px solid #ddd;"></select>
                    <input type="date" id="filter-tanggal" style="padding: 10px; border-radius: 5px; border: 1px solid #ddd;">
                    <button onclick="renderRekap()" style="background:#3498db; color:white; border:none; padding:10px 20px; border-radius:5px; cursor:pointer;">Tampilkan</button>
                    <button onclick="printRekap()" style="background:#27ae60; color:white; border:none; padding:10px 20px; border-radius:5px; cursor:pointer;">üñ®Ô∏è Cetak</button>
                </div>
                <div id="rekap-result" style="background: white; padding: 20px; border-radius: 10px; border: 1px solid #ddd;">
                    <p style="text-align:center; color:#999;">Pilih kelas dan tanggal terlebih dahulu.</p>
                </div>
            </section>
        </main>
    </div>

    <script src="script-common.js"></script>
    <script>
        // Set default tanggal hari ini
        document.getElementById('filter-tanggal').value = new Date().toISOString().split('T')[0];

        function show(s) {
            document.querySelectorAll('section').forEach(el => el.classList.add('hidden'));
            document.getElementById('sec-' + s).classList.remove('hidden'); 
            if (s === 'rekap') updateKelasDropdown();
            render();
        }

        async function render() {
            const q = document.getElementById('search').value.toLowerCase();
            
            // 1. RENDER LAPORAN (LOG) - TERMASUK STATUS PULANG
            const logBody = document.getElementById('tbody-log');
            if (logBody && !document.getElementById('sec-laporan').classList.contains('hidden')) {
                const allLogs = await getLogs();
                const logs = allLogs.reverse().filter(l => 
                    (l.name && l.name.toLowerCase().includes(q)) || 
                    (l.kelas && l.kelas.toLowerCase().includes(q))
                );

                logBody.innerHTML = logs.map(l => {
                    let statusClass = "status-late";
                    if(l.mode === "TEPAT WAKTU") statusClass = "status-ok";
                    if(l.mode === "PULANG") statusClass = "status-blue";

                    return `
                    <tr>
                        <td>${new Date(l.timestamp).toLocaleString('id-ID')}</td>
                        <td><b>${l.name}</b></td>
                        <td>${l.kelas}</td>
                        <td><span class="status-pill ${statusClass}" style="font-size:11px; padding:4px 10px;">${l.mode}</span></td>
                        <td><button onclick="delL('${l.timestamp}')" class="btn-del">Hapus</button></td>
                    </tr>`;
                }).join('');
            }

            // 2. RENDER MASTER SISWA
            const studentBody = document.getElementById('tbody-siswa');
            if(studentBody && !document.getElementById('sec-siswa').classList.contains('hidden')) {
                const students = await getStudents();
                studentBody.innerHTML = students.map(s => `
                    <tr>
                        <td style="text-align:center;">
                            <img src="img/siswa/${s.id}.jpg" 
                                 onerror="this.onerror=null; this.src='img/siswa/${s.id}.png'; this.setAttribute('onerror', 'this.src=\'https://via.placeholder.com/45x55?text=üë§\'')" 
                                 class="img-table">
                        </td>
                        <td><code>${s.id}</code></td>
                        <td><b>${s.name}</b></td>
                        <td>${s.kelas}</td>
                        <td>${s.wa || '-'}</td>
                        <td style="text-align:center;">
                            <button onclick="editSiswa('${s.id}')" class="btn-edit">Edit</button>
                            <button onclick="delS('${s.id}')" class="btn-del">Hapus</button>
                        </td>
                    </tr>`).join('');
            }
        }

        async function updateKelasDropdown() {
            const students = await getStudents();
            const listKelas = [...new Set(students.map(s => s.kelas))].sort();
            document.getElementById('filter-kelas').innerHTML = '<option value="">-- Pilih Kelas --</option>' + 
                listKelas.map(k => `<option value="${k}">${k}</option>`).join('');
        }

        async function renderRekap() {
            const kelas = document.getElementById('filter-kelas').value;
            const tglInput = document.getElementById('filter-tanggal').value;
            if (!kelas || !tglInput) return alert("Pilih kelas & tanggal!");
            
            const rekapResult = document.getElementById('rekap-result');
            rekapResult.innerHTML = "<p style='text-align:center;'>Mengambil data...</p>";

            const selectedDate = new Date(tglInput).toLocaleDateString('id-ID');
            const studentsData = await getStudents();
            const students = studentsData.filter(s => s.kelas === kelas);
            const logs = await getLogs();

            let html = `<h3 style="text-align:center">LAPORAN ABSENSI KELAS: ${kelas}</h3>
                        <p style="text-align:center">Tanggal: <b>${selectedDate}</b></p>`;
            html += `<table>
                        <thead><tr><th>Nama Siswa</th><th style="text-align:center">Status</th><th style="text-align:center">Jam</th></tr></thead><tbody>`;

            students.forEach(s => {
                // Cari data absensi untuk siswa ini pada tanggal yang dipilih
                const log = logs.find(l => String(l.id) === String(s.id) && new Date(l.timestamp).toLocaleDateString('id-ID') === selectedDate);
                
                const statusText = log ? log.mode : "Alpa";
                const jamText = log ? new Date(log.timestamp).toLocaleTimeString('id-ID', {hour:'2-digit', minute:'2-digit'}) : "-";
                
                let statusClass = "";
                if(log) {
                    if(log.mode === "TEPAT WAKTU") statusClass = "status-ok";
                    else if(log.mode === "PULANG") statusClass = "status-blue";
                    else statusClass = "status-late";
                }

                html += `<tr>
                            <td>${s.name}</td>
                            <td style="text-align:center;"><span class="${log ? 'status-pill ' + statusClass : ''}" style="font-size:11px; color:${log?'white':'red'}">${statusText}</span></td>
                            <td style="text-align:center;">${jamText}</td>
                        </tr>`;
            });
            html += `</tbody></table>`;
            rekapResult.innerHTML = html;
        }

        async function editSiswa(id) {
            let students = await getStudents();
            let index = students.findIndex(s => String(s.id) === String(id));
            if (index !== -1) {
                const s = students[index];
                const nNama = prompt("Edit Nama:", s.name); if (!nNama) return;
                const nKelas = prompt("Edit Kelas:", s.kelas); if (!nKelas) return;
                const nWA = prompt("Edit WA (62...):", s.wa); if (!nWA) return;

                students[index].name = nNama;
                students[index].kelas = nKelas;
                students[index].wa = nWA.replace(/[^\d]/g, "");

                await fetch(`${dbRootURL}master_siswa.json`, { method: 'PUT', body: JSON.stringify(students) });
                alert("Data diperbarui!");
                render();
            }
        }

        async function delS(id) {
            if(confirm('Hapus siswa ini?')) {
                let students = await getStudents();
                let filtered = students.filter(s => String(s.id) !== String(id));
                await fetch(`${dbRootURL}master_siswa.json`, { method: 'PUT', body: JSON.stringify(filtered) });
                render();
            }
        }

        async function clearAllLogs() { 
            if(confirm('Hapus SEMUA data absensi secara permanen dari Cloud?')) { 
                await fetch(`${dbRootURL}absensi.json`, { method: 'DELETE' });
                alert("Semua log dihapus!");
                render();
            } 
        }

        function saveS() {
            localStorage.setItem('absensi_config', JSON.stringify({jamMasuk: document.getElementById('jam-m').value}));
            alert('Batas jam masuk berhasil disimpan!');
        }

        function printRekap() {
            const content = document.getElementById('rekap-result').innerHTML;
            if (content.includes("Pilih kelas")) return alert("Tampilkan data terlebih dahulu!");
            const win = window.open('', '', 'height=700,width=900');
            win.document.write(`<html><head><title>Cetak Rekap</title>
                <style>
                    body{font-family:Arial;padding:30px}
                    table{width:100%;border-collapse:collapse;margin-top:20px}
                    th,td{border:1px solid #ddd;padding:10px;text-align:left}
                    th{background:#f2f2f2}
                    .status-pill{padding:4px 8px; border-radius:10px; color:white; font-size:10px}
                    .status-ok{background:green}
                    .status-late{background:red}
                    .status-blue{background:#3498db}
                </style></head><body>${content}</body></html>`);
            win.document.close();
            setTimeout(() => { win.print(); win.close(); }, 500);
        }

        // Inisialisasi awal
        document.getElementById('jam-m').value = getConfig().jamMasuk;
        render();
    </script>
</body>
</html>
