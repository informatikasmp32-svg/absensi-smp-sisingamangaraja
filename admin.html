<script src="script-common.js"></script>
    <script>
        document.getElementById('filter-tanggal').value = new Date().toISOString().split('T')[0];

        function show(s) {
            document.querySelectorAll('section').forEach(el => el.classList.add('hidden'));
            document.getElementById('sec-' + s).classList.remove('hidden'); 
            if (s === 'rekap') updateKelasDropdown();
            render();
        }

        async function render() {
            const q = document.getElementById('search').value.toLowerCase();
            
            // 1. Render Log Absensi
            const logBody = document.getElementById('tbody-log');
            if (logBody) {
                const allLogs = await getLogs();
                const logs = allLogs.reverse().filter(l => 
                    l.name.toLowerCase().includes(q) || (l.kelas && l.kelas.toLowerCase().includes(q))
                );
                logBody.innerHTML = logs.map(l => `
                    <tr>
                        <td>${new Date(l.timestamp).toLocaleString('id-ID')}</td>
                        <td><b>${l.name}</b></td>
                        <td>${l.kelas}</td>
                        <td><span class="badge ${l.mode.toLowerCase().replace(' ', '-')}">${l.mode}</span></td>
                        <td><button onclick="delL('${l.timestamp}')" class="btn-del">Hapus</button></td>
                    </tr>`).join('');
            }

            // 2. Render Master Siswa
            const studentBody = document.getElementById('tbody-siswa');
            if(studentBody) {
                const students = await getStudents();
                studentBody.innerHTML = students.map(s => `
                    <tr>
                        <td><img src="img/siswa/${s.id}.jpg" onerror="this.src='https://via.placeholder.com/40x50?text=üë§'" class="img-table"></td>
                        <td><code>${s.id}</code></td>
                        <td>${s.name}</td>
                        <td>${s.kelas}</td>
                        <td>${s.wa || '-'}</td>
                        <td style="text-align:center;">
                            <button onclick="editSiswa('${s.id}')" style="background:#f39c12; color:white; border:none; padding:4px 8px; border-radius:4px; cursor:pointer;">‚úèÔ∏è Edit</button>
                            <button onclick="delS('${s.id}')" class="btn-del">üóëÔ∏è Hapus</button>
                        </td>
                    </tr>`).join('');
            }
        }

        async function editSiswa(id) {
            let students = await getStudents();
            let index = students.findIndex(s => s.id === id);
            if (index !== -1) {
                const s = students[index];
                const nNama = prompt("Edit Nama:", s.name);
                const nKelas = prompt("Edit Kelas:", s.kelas);
                const nWA = prompt("Edit WA (Contoh: 62812...):", s.wa);
                
                if (nNama && nKelas && nWA) {
                    students[index].name = nNama;
                    students[index].kelas = nKelas;
                    students[index].wa = nWA.replace(/[^\d]/g, "");
                    
                    await fetch(`${dbRootURL}master_siswa.json`, { method: 'PUT', body: JSON.stringify(students) });
                    alert("Data berhasil diperbarui!");
                    render();
                }
            }
        }

        async function delS(id) {
            if(confirm('Hapus siswa ini?')) {
                let students = await getStudents();
                let filtered = students.filter(s => s.id !== id);
                await fetch(`${dbRootURL}master_siswa.json`, { method: 'PUT', body: JSON.stringify(filtered) });
                render();
            }
        }

        async function clearAllLogs() { 
            if(confirm('Hapus SEMUA data absensi?')) { 
                await fetch(`${dbRootURL}absensi.json`, { method: 'DELETE' });
                render();
            } 
        }

        // Jalankan awal
        render();
    </script>
</body>
</html>
